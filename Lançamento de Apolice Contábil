CREATE OR REPLACE PROCEDURE "AD_STP_TCSCON_LANC" (
       P_CODUSU NUMBER,        -- Código do usuário logado
       P_IDSESSAO VARCHAR2,    -- Identificador da execução. Serve para buscar informações dos parâmetros/campos da execução.
       P_QTDLINHAS NUMBER,     -- Informa a quantidade de registros selecionados no momento da execução.
       P_MENSAGEM OUT VARCHAR2 -- Caso seja passada uma mensagem aqui, ela será exibida como uma informação ao usuário.
) AS
       PARAM_DATAINI DATE;
       PARAM_DATAFIN DATE;
       FIELD_NUMCONTRATO NUMBER;
       FIELD_NUMLANC NUMBER;
       V_NUMLANC NUMBER;
       V_NUMCONTRATO NUMBER;
       V_COUNT NUMBER; 
       V_RATEIO NUMBER;
       V_MESES NUMBER; 
       V_STATUS VARCHAR2(1);
       V_DESCRICAO VARCHAR2(400);       
       V_NUMLANC2 NUMBER;
       V_NUMLANC3 NUMBER;
       V_NUMCONTRATO2 NUMBER;
       V_CHASSI VARCHAR2(400);
       V_VEICULO VARCHAR2(400);
       V_PLACA VARCHAR2(400);
       V_HISTORICO VARCHAR2(400);       
       V_SEGURADORA VARCHAR2(400);   
       V_MUNICIPIO VARCHAR2(400);   
       V_TIPCONT VARCHAR2(1);
       V_DTLP DATE;
       V_STATUSLP VARCHAR2(1);
       V_CODCTACTB NUMBER;
       V_CODCTACTB2 NUMBER;
       V_CODCTACTB3 NUMBER;
       V_CODCTACTB4 NUMBER;

BEGIN 

PARAM_DATAINI := ACT_DTA_PARAM(P_IDSESSAO, 'DATAINI'); 
PARAM_DATAFIN := ACT_DTA_PARAM(P_IDSESSAO, 'DATAFIN'); 

FOR I IN 1..P_QTDLINHAS LOOP 

FIELD_NUMCONTRATO := ACT_INT_FIELD(P_IDSESSAO, I, 'NUMCONTRATO'); 

SELECT  COUNT(1) INTO V_COUNT
FROM AD_TCSLAN
WHERE REFERENCIA BETWEEN PARAM_DATAINI AND PARAM_DATAFIN
AND NUMCONTRATO = FIELD_NUMCONTRATO; 

SELECT AD_CODCTACTB, AD_CODCTACTB2, AD_CODCTACTBCP, AD_CODCTACTBLP
       INTO V_CODCTACTB, V_CODCTACTB2, V_CODCTACTB3, V_CODCTACTB4
FROM TCSCON 
WHERE NUMCONTRATO = FIELD_NUMCONTRATO; 

SELECT NVL(STATUSCONT,'N'), NUMLANC INTO V_STATUS, V_NUMLANC2
FROM AD_TCSCONCONTABIL
WHERE PERIODOINI BETWEEN PARAM_DATAINI AND PARAM_DATAFIN
AND NUMCONTRATO = FIELD_NUMCONTRATO;

SELECT MAX(NUMLANC) AS NUMLANC, NUMCONTRATO
INTO V_NUMLANC3, V_NUMCONTRATO2
FROM AD_TCSCONCONTABIL
WHERE NUMCONTRATO = FIELD_NUMCONTRATO
GROUP BY NUMCONTRATO;

SELECT NVL(AD_TIPOCONT, ''), NVL(AD_DESCRICAO, ''), 
       NVL(AD_PLACA,''), NVL(AD_CHASSI, ''), 
       NVL(AD_VEICULO, ''), NVL(AD_SEGURADORA, ''), 
       NVL(AD_MUNICIPIO, '')
INTO V_TIPCONT, V_DESCRICAO, 
       V_PLACA, V_CHASSI,   
       V_VEICULO, V_SEGURADORA, 
       V_MUNICIPIO
FROM TCSCON
WHERE NUMCONTRATO = FIELD_NUMCONTRATO;

SELECT MONTHS_BETWEEN(AD_DTFIN, PARAM_DATAINI) INTO V_MESES 
FROM TCSCON
WHERE NUMCONTRATO = FIELD_NUMCONTRATO; 

UPDATE AD_TCSCONCONTABIL SET STATUSCONT = 'S' WHERE NUMCONTRATO = FIELD_NUMCONTRATO AND NUMLANC = V_NUMLANC2;

IF V_TIPCONT = 'V' THEN 
V_HISTORICO := 'VALOR REFERENTE APROPRIACAO DE DESPESAS CONFORME SEGURO '|| V_VEICULO || ' CHASSI '||V_CHASSI || ' PLACA '||V_PLACA ||' SEGURADORA '|| V_SEGURADORA ||' APOLICE '|| V_DESCRICAO ||' - '|| V_NUMLANC2  ||'/'|| V_NUMLANC3 ||'..';
END IF;

IF V_TIPCONT = 'A' THEN 
V_HISTORICO := 'VALOR DE DESPESAS REFERENTE IPTU/ ALVARÁ ANO '|| TO_CHAR(PARAM_DATAINI, 'YYYY') || ' MUNICIPIO '|| V_MUNICIPIO || ' - '|| V_NUMLANC2  ||'/'|| V_NUMLANC3 ||'.';
END IF;

IF V_TIPCONT = 'E' OR  V_TIPCONT = 'S' THEN 
V_HISTORICO := 'VALOR REFERENTE APROPRIACAO DE DESPESAS CONFORME SEGURO EMPRESARIAL DA SEGURADORA '|| V_SEGURADORA || ' APOLICE Nº '|| V_DESCRICAO || ' - '|| V_NUMLANC2  ||'/'|| V_NUMLANC3 ||'.';
END IF;

IF V_TIPCONT = 'L' THEN 
V_HISTORICO := 'VALOR APROPRIAÇÃO DESPESAS REFERENTE LICENÇA ANTIVIRUS  - '|| V_NUMLANC2 ||'/'|| V_NUMLANC3 ||'..';
END IF;

IF V_TIPCONT = 'S' THEN 
V_HISTORICO := 'VALOR REFERENTE APROPRIACAO DE DESPESAS CONFORME SEGURO DE VIDA DA SEGURADORA '|| V_SEGURADORA || ' APOLICE Nº '|| V_DESCRICAO || ' - '|| V_NUMLANC2  ||'/'|| V_NUMLANC3 ||'.';
END IF;

IF V_COUNT = 0 THEN

       SELECT  COUNT(1) INTO V_RATEIO
       FROM AD_TCSCONRATEIO
       WHERE NUMCONTRATO = FIELD_NUMCONTRATO; 


       IF V_STATUS <> 'S' THEN 

       IF V_CODCTACTB IS NULL OR V_CODCTACTB2 IS NULL OR V_CODCTACTB3 IS NULL OR V_CODCTACTB4 IS NULL AND V_TIPCONT <> 'A'  THEN 
              RAISE_APPLICATION_ERROR(-20001, 'Para Contabilizar o Registro Necessita de Todas as Contas Contábeis Informadas.');
       END IF;

       IF V_TIPCONT = 'A' AND (V_CODCTACTB IS NULL OR V_CODCTACTB2 IS NULL) AND V_MESES > 12  THEN 
              RAISE_APPLICATION_ERROR(-20001, 'Para Contabilizar o Registro Necessita de Todas as Contas Contábeis Informadas.');
       END IF;


       IF V_RATEIO = 0 THEN

              INSERT INTO AD_TCSLAN (NUMCONTRATO, NUMLANC, TIPLANC, CODCTACTB, HISTORICO, VLRLANC, SEQUENCIA, NUMLOTE, CODEMP, DTMOV, REFERENCIA, CODCENCUS, NUMLANCSEG)
              SELECT  FIELD_NUMCONTRATO
                     ,NVL(MAX(LAN.NUMLANC),0)+ ROW_NUMBER() OVER(ORDER BY NVL(MAX(LAN.NUMLANC),0) ASC)
                     ,'D'
                     ,CON.AD_CODCTACTB
                     ,V_HISTORICO
                     ,CT.VLRDESPESA
                     ,'1'
                     ,'1003'
                     ,CT.CODEMP
                     ,CT.PERIODOFIN
                     ,CT.REFERENCIA
                     ,CON.CODCENCUS
                     ,CT.NUMLANC
              FROM AD_TCSCONCONTABIL CT
              INNER JOIN TCSCON CON ON CON.NUMCONTRATO = CT.NUMCONTRATO
              INNER JOIN TGFNAT NAT ON NAT.CODNAT = CON.AD_CODNAT 
              LEFT JOIN AD_TCSLAN LAN ON LAN.NUMCONTRATO = CT.NUMCONTRATO
              WHERE CT.NUMCONTRATO = FIELD_NUMCONTRATO
              AND CT.PERIODOINI >= PARAM_DATAINI
              AND CT.PERIODOFIN <= PARAM_DATAFIN
              GROUP BY  CON.AD_CODCTACTB
                       ,CON.CODCENCUS              
                       ,CT.VLRDESPESA
                       ,CT.CODEMP
                       ,CT.REFERENCIA
                       ,CT.PERIODOFIN
                       ,CT.NUMLANC
                       ,V_HISTORICO;



              INSERT INTO AD_TCSLAN (NUMCONTRATO, NUMLANC, TIPLANC, CODCTACTB, HISTORICO, VLRLANC, SEQUENCIA, NUMLOTE, CODEMP, DTMOV, REFERENCIA, CODCENCUS, NUMLANCSEG)
              SELECT  FIELD_NUMCONTRATO
                     ,NVL(MAX(LAN.NUMLANC),0)+ ROW_NUMBER() OVER(ORDER BY NVL(MAX(LAN.NUMLANC),0) ASC)
                     ,'R'
                     ,CON.AD_CODCTACTB2
                     ,V_HISTORICO
                     ,CT.VLRDESPESA
                     ,'1'
                     ,'1003'
                     ,CT.CODEMP
                     ,CT.PERIODOFIN
                     ,CT.REFERENCIA
                     ,CON.CODCENCUS
                     ,CT.NUMLANC                                  
              FROM AD_TCSCONCONTABIL CT
              INNER JOIN TCSCON CON ON CON.NUMCONTRATO = CT.NUMCONTRATO
              INNER JOIN TGFNAT NAT ON NAT.CODNAT = CON.AD_CODNAT
              LEFT JOIN AD_TCSLAN LAN ON LAN.NUMCONTRATO = CT.NUMCONTRATO
              WHERE CT.NUMCONTRATO = FIELD_NUMCONTRATO
              AND CT.PERIODOINI >= PARAM_DATAINI
              AND CT.PERIODOFIN <= PARAM_DATAFIN
              GROUP BY  CON.AD_CODCTACTB2
                       ,CON.CODCENCUS              
                       ,CT.VLRDESPESA
                       ,CT.CODEMP
                       ,CT.REFERENCIA
                       ,CT.PERIODOFIN
                       ,CT.NUMLANC
                       ,V_HISTORICO;
       END IF; 


       IF V_RATEIO >= 1 THEN
              INSERT INTO AD_TCSLAN (NUMCONTRATO, NUMLANC, TIPLANC, CODCTACTB, HISTORICO, VLRLANC, SEQUENCIA, NUMLOTE, CODEMP, DTMOV, REFERENCIA, CODCENCUS, NUMLANCSEG)
              SELECT  RAT.NUMCONTRATO
              ,NVL(MAX(LAN.NUMLANC),0)+ ROW_NUMBER() OVER(ORDER BY NVL(MAX(LAN.NUMLANC),0) ASC)
              ,'R'
              ,RAT.CODCTACTB
              ,V_HISTORICO
              ,(CT.VLRDESPESA* (RAT.PERC/100))
              ,'1'
              ,'1003'
              ,CT.CODEMP
              ,CT.PERIODOFIN
              ,CT.REFERENCIA
              ,CON.CODCENCUS
              ,CT.NUMLANC   
              FROM AD_TCSCONRATEIO RAT
              INNER JOIN AD_TCSCONCONTABIL CT  ON CT.NUMCONTRATO = RAT.NUMCONTRATO
              INNER JOIN TCSCON CON ON CON.NUMCONTRATO = CT.NUMCONTRATO
              INNER JOIN TGFNAT NAT ON NAT.CODNAT = CON.AD_CODNAT
              LEFT JOIN AD_TCSLAN LAN ON LAN.NUMCONTRATO = CT.NUMCONTRATO
              WHERE CT.NUMCONTRATO = FIELD_NUMCONTRATO
              AND CT.PERIODOINI >= PARAM_DATAINI
              AND CT.PERIODOFIN <= PARAM_DATAFIN
              GROUP BY  RAT.CODCTACTB
                        ,CON.CODCENCUS 
                     ,RAT.NUMCONTRATO
                     ,CT.VLRDESPESA
                     ,CT.CODEMP
                     ,CT.REFERENCIA
                     ,CT.PERIODOFIN
                     ,RAT.PERC
                     ,CT.NUMLANC;

              INSERT INTO AD_TCSLAN (NUMCONTRATO, NUMLANC, TIPLANC, CODCTACTB, HISTORICO, VLRLANC, SEQUENCIA, NUMLOTE, CODEMP, DTMOV, REFERENCIA, CODCENCUS, NUMLANCSEG)
              SELECT  FIELD_NUMCONTRATO
                     ,NVL(MAX(LAN.NUMLANC),0)+ ROW_NUMBER() OVER(ORDER BY NVL(MAX(LAN.NUMLANC),0) ASC)
                     ,'D'
                     ,CON.AD_CODCTACTB2
                     ,V_HISTORICO
                     ,(CT.VLRDESPESA* (RAT.PERC/100))
                     ,'1'
                     ,'1003'
                     ,CT.CODEMP
                     ,CT.PERIODOFIN
                     ,CT.REFERENCIA
                     ,CON.CODCENCUS
                     ,CT.NUMLANC
              FROM AD_TCSCONRATEIO RAT
              INNER JOIN AD_TCSCONCONTABIL CT  ON CT.NUMCONTRATO = RAT.NUMCONTRATO
              INNER JOIN TCSCON CON ON CON.NUMCONTRATO = CT.NUMCONTRATO
              INNER JOIN TGFNAT NAT ON NAT.CODNAT = CON.AD_CODNAT
              LEFT JOIN AD_TCSLAN LAN ON LAN.NUMCONTRATO = CT.NUMCONTRATO
              WHERE CT.NUMCONTRATO = FIELD_NUMCONTRATO
              AND CT.PERIODOINI >= PARAM_DATAINI
              AND CT.PERIODOFIN <= PARAM_DATAFIN
              GROUP BY  RAT.CODCTACTB
                        ,CON.CODCENCUS 
                    , CON.AD_CODCTACTB2
                     ,RAT.NUMCONTRATO
                     ,NAT.CODCTACTB2
                     ,CT.VLRDESPESA
                     ,CT.CODEMP
                     ,CT.REFERENCIA
                     ,CT.PERIODOFIN
                     ,RAT.PERC
                     ,CT.NUMLANC;
       END IF; 


-- LONGO PRAZO -- 

       INSERT INTO AD_TCSLAN (NUMCONTRATO, NUMLANC, TIPLANC, CODCTACTB, HISTORICO, VLRLANC, SEQUENCIA, NUMLOTE, CODEMP, DTMOV, REFERENCIA, CODCENCUS, NUMLANCSEG)
              SELECT  FIELD_NUMCONTRATO
                     ,NVL(MAX(LAN.NUMLANC),0)+ ROW_NUMBER() OVER(ORDER BY NVL(MAX(LAN.NUMLANC),0) ASC)
                     ,'D'
                     ,CON.AD_CODCTACTBCP
                     ,'TRANSFERENCIA DE DESPESAS A APROPRIAR DE LONGO PARA CURTO PRAZO '|| V_DESCRICAO || '.'
                     ,CT.VLRDESPESA
                     ,'1'
                     ,'1002'
                     ,CT.CODEMP
                     ,ADD_MONTHS(CT.PERIODOFIN, -12)
                     ,CT.REFERENCIA
                     ,CON.CODCENCUS
                     ,CT.NUMLANC
              FROM AD_TCSCONCONTABIL CT
              INNER JOIN TCSCON CON ON CON.NUMCONTRATO = CT.NUMCONTRATO
              INNER JOIN TGFNAT NAT ON NAT.CODNAT = CON.AD_CODNAT 
              LEFT JOIN AD_TCSLAN LAN ON LAN.NUMCONTRATO = CT.NUMCONTRATO
              WHERE CT.NUMCONTRATO = FIELD_NUMCONTRATO
              AND CT.PERIODOINI >= ADD_MONTHS(PARAM_DATAINI, 12)
              AND CT.PERIODOFIN <= ADD_MONTHS(PARAM_DATAFIN, 12)
              AND CT.STATUSLP = 'S'
              GROUP BY  CON.AD_CODCTACTBCP
                       ,CON.CODCENCUS              
                       ,CT.VLRDESPESA
                       ,CT.CODEMP
                       ,CT.REFERENCIA
                       ,CT.PERIODOFIN
                       ,CT.NUMLANC;

       INSERT INTO AD_TCSLAN (NUMCONTRATO, NUMLANC, TIPLANC, CODCTACTB, HISTORICO, VLRLANC, SEQUENCIA, NUMLOTE, CODEMP, DTMOV, REFERENCIA, CODCENCUS, NUMLANCSEG)
              SELECT  FIELD_NUMCONTRATO
                     ,NVL(MAX(LAN.NUMLANC),0)+ ROW_NUMBER() OVER(ORDER BY NVL(MAX(LAN.NUMLANC),0) ASC)
                     ,'R'
                     ,CON.AD_CODCTACTBLP
                     ,'TRANSFERENCIA DE DESPESAS A APROPRIAR DE LONGO PARA CURTO PRAZO '|| V_DESCRICAO || '.'
                     ,CT.VLRDESPESA
                     ,'1'
                     ,'1002'
                     ,CT.CODEMP
                     ,ADD_MONTHS(CT.PERIODOFIN, -12)
                     ,CT.REFERENCIA
                     ,CON.CODCENCUS
                     ,CT.NUMLANC
              FROM AD_TCSCONCONTABIL CT
              INNER JOIN TCSCON CON ON CON.NUMCONTRATO = CT.NUMCONTRATO
              INNER JOIN TGFNAT NAT ON NAT.CODNAT = CON.AD_CODNAT 
              LEFT JOIN AD_TCSLAN LAN ON LAN.NUMCONTRATO = CT.NUMCONTRATO
              WHERE CT.NUMCONTRATO = FIELD_NUMCONTRATO
              AND CT.PERIODOINI >= ADD_MONTHS(PARAM_DATAINI, 12)
              AND CT.PERIODOFIN <= ADD_MONTHS(PARAM_DATAFIN, 12)
              AND CT.STATUSLP = 'S'
              GROUP BY  CON.AD_CODCTACTBLP
                       ,CON.CODCENCUS              
                       ,CT.VLRDESPESA
                       ,CT.CODEMP
                       ,CT.REFERENCIA
                       ,CT.PERIODOFIN
                       ,CT.NUMLANC;

    END IF; 
    END IF; 

    IF V_STATUS = 'S' THEN 
       RAISE_APPLICATION_ERROR(-20001, 'Apólice já Contabilizada.');
    END IF;

END LOOP;

END;

/
