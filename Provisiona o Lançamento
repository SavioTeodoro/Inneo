CREATE OR REPLACE PROCEDURE AD_STP_TCSCON_CONT (
    P_CODUSU NUMBER,        -- Código do usuário logado
    P_IDSESSAO VARCHAR2,    -- Identificador da execução. Serve para buscar informações dos parâmetros/campos da execução.
    P_QTDLINHAS NUMBER,     -- Informa a quantidade de registros selecionados no momento da execução.
    P_MENSAGEM OUT VARCHAR2 -- Caso seja passada uma mensagem aqui, ela será exibida como uma informação ao usuário.
) AS
    FIELD_NUMCONTRATO NUMBER;
    V_CODEMP INT;
    V_NUMCONTRATO INT;
    V_MESES INT;
    V_MAX_NUMLANC INT;
    V_VLRDIAS FLOAT;
    V_CALC FLOAT;
    V_PRIMEIRO DATE;
    V_ULTIMO DATE;
    V_REFERENCIA DATE;
    V_STATUS VARCHAR2(1);
    V_DTIN DATE;

BEGIN
    FOR I IN 1..P_QTDLINHAS LOOP
        FIELD_NUMCONTRATO := ACT_INT_FIELD(P_IDSESSAO, I, 'NUMCONTRATO');

        SELECT
            AD_CODEMP,
            NUMCONTRATO,
            ADD_MONTHS(TRUNC(AD_DTIN, 'MM'), ROWNUM - 1) AS REFERENCIA,
            (AD_VLRCONTRATO/((AD_DTFIN - AD_DTIN)+1)) AS VLRDIAS,
            ADD_MONTHS(TRUNC(AD_DTIN, 'MM'), ROWNUM) - ADD_MONTHS(TRUNC(AD_DTIN, 'MM'), ROWNUM - 1) AS CALC,
            AD_DTIN AS PRIMEIRO,
            LAST_DAY(ADD_MONTHS(TRUNC(AD_DTIN, 'MM'), ROWNUM - 1)) AS ULTIMO,
            MONTHS_BETWEEN(TRUNC(AD_DTFIN, 'MM'), TRUNC(AD_DTIN, 'MM'))+1 AS MESES,
            NVL(AD_STATUS, 'N')
        INTO
            V_CODEMP,
            V_NUMCONTRATO,
            V_REFERENCIA,
            V_VLRDIAS,
            V_CALC,
            V_PRIMEIRO,
            V_ULTIMO,
            V_MESES,
            V_STATUS
        FROM
            TCSCON
        WHERE
            NUMCONTRATO = FIELD_NUMCONTRATO;

        IF V_STATUS <> 'S' THEN 
        FOR J IN 1..V_MESES LOOP
            SELECT
                NVL(MAX(NUMLANC) + 1, 1)
            INTO
                V_MAX_NUMLANC
            FROM
                AD_TCSCONCONTABIL
            WHERE
                NUMCONTRATO = FIELD_NUMCONTRATO;

            IF J = 1 THEN
            SELECT AD_DTIN,
            (LAST_DAY(AD_DTIN) - AD_DTIN +1)
            INTO V_PRIMEIRO,
            V_CALC
            FROM TCSCON
            WHERE NUMCONTRATO = FIELD_NUMCONTRATO;

                INSERT INTO AD_TCSCONCONTABIL (CODEMP, NUMCONTRATO, NUMLANC, REFERENCIA, VLRDESPESA, VLRDESPESADIA, DIAS, PERIODOINI, PERIODOFIN, STATUSCONT)
                VALUES (V_CODEMP, V_NUMCONTRATO, V_MAX_NUMLANC, V_REFERENCIA, V_CALC * V_VLRDIAS, V_VLRDIAS, V_CALC, V_PRIMEIRO, V_ULTIMO, 'N');

            ELSIF J > 1 AND J < V_MESES THEN

            SELECT ADD_MONTHS(TRUNC(AD_DTIN,'MM'), J-1),
             (LAST_DAY(ADD_MONTHS(TRUNC(AD_DTIN,'MM'), J-1)) - ADD_MONTHS(TRUNC(AD_DTIN,'MM'), J-1)+1),
             LAST_DAY(ADD_MONTHS(TRUNC(AD_DTIN,'MM'), J-1)),
             ADD_MONTHS(TRUNC(AD_DTIN,'MM'), J-1)
            INTO V_PRIMEIRO, 
            V_CALC,
            V_ULTIMO,
            V_REFERENCIA
            FROM TCSCON
            WHERE NUMCONTRATO = FIELD_NUMCONTRATO;            

                INSERT INTO AD_TCSCONCONTABIL (CODEMP, NUMCONTRATO, NUMLANC, REFERENCIA, VLRDESPESA, VLRDESPESADIA, DIAS, PERIODOINI, PERIODOFIN, STATUSCONT)
                VALUES (V_CODEMP, V_NUMCONTRATO, V_MAX_NUMLANC, V_REFERENCIA, V_CALC * V_VLRDIAS, V_VLRDIAS, V_CALC, V_PRIMEIRO, V_ULTIMO, 'N');


            ELSIF J = V_MESES THEN
            SELECT ADD_MONTHS(TRUNC(AD_DTIN,'MM'), J-1),
            AD_DTFIN,
            ADD_MONTHS(TRUNC(AD_DTIN,'MM'), J-1),
            ((AD_DTFIN-ADD_MONTHS(TRUNC(AD_DTIN,'MM'), J-1))+1)
            INTO V_PRIMEIRO,
            V_ULTIMO,
            V_REFERENCIA,
            V_CALC
            FROM TCSCON
            WHERE NUMCONTRATO = FIELD_NUMCONTRATO;           
                INSERT INTO AD_TCSCONCONTABIL (CODEMP, NUMCONTRATO, NUMLANC, REFERENCIA, VLRDESPESA, VLRDESPESADIA, DIAS, PERIODOINI, PERIODOFIN, STATUSCONT)
                VALUES (V_CODEMP, V_NUMCONTRATO, V_MAX_NUMLANC, V_REFERENCIA, V_CALC * V_VLRDIAS, V_VLRDIAS, V_CALC, V_PRIMEIRO, V_ULTIMO, 'N');
           END IF;

           UPDATE TCSCON SET AD_STATUS = 'S' WHERE NUMCONTRATO = FIELD_NUMCONTRATO;
        END LOOP;
        END IF; 

        IF V_STATUS = 'S' THEN 
                RAISE_APPLICATION_ERROR(-20001, 'Apólice já provisionada.');
        END IF;
    END LOOP;

    SELECT AD_DTIN INTO V_DTIN
    FROM TCSCON
    WHERE NUMCONTRATO = FIELD_NUMCONTRATO;

    UPDATE AD_TCSCONCONTABIL SET STATUSLP = 'N' WHERE  MONTHS_BETWEEN(PERIODOINI, V_DTIN) < 12 AND NUMCONTRATO = FIELD_NUMCONTRATO;
    UPDATE AD_TCSCONCONTABIL SET STATUSLP = 'S' WHERE  MONTHS_BETWEEN(PERIODOINI,  V_DTIN) >= 12 AND NUMCONTRATO = FIELD_NUMCONTRATO;

END;





/
